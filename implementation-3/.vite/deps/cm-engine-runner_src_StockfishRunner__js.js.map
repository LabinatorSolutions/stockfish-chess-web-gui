{
  "version": 3,
  "sources": ["../../node_modules/cm-engine-runner/src/StockfishRunner.js"],
  "sourcesContent": ["/**\n * Author and copyright: Stefan Haack (https://shaack.com)\n * Repository: https://github.com/shaack/cm-chess-engine-runner\n * License: MIT, see file 'LICENSE'\n */\n\nimport {ENGINE_STATE, EngineRunner} from \"./EngineRunner.js\"\n\n// [depth, Skill Level]\nexport const LEVELS = {\n    1: [3, 0],\n    2: [3, 1],\n    3: [4, 2],\n    4: [5, 3],\n    5: [5, 4],\n    6: [6, 5],\n    7: [7, 6],\n    8: [8, 7],\n    9: [9, 8],\n    10: [10, 10],\n    11: [11, 11],\n    12: [12, 12],\n    13: [13, 13],\n    14: [14, 14],\n    15: [15, 15],\n    16: [16, 16],\n    17: [17, 17],\n    18: [18, 18],\n    19: [19, 19],\n    20: [20, 20]\n}\n\nexport class StockfishRunner extends EngineRunner {\n\n    constructor(props) {\n        super(props)\n    }\n\n    init() {\n        return new Promise((resolve) => {\n            const listener = (event) => {\n                this.workerListener(event)\n            }\n            if (this.engineWorker) {\n                this.engineWorker.removeEventListener(\"message\", listener)\n                this.engineWorker.terminate()\n            }\n            this.engineWorker = new Worker(this.props.workerUrl)\n            this.engineWorker.addEventListener(\"message\", listener)\n\n            this.uciCmd('uci')\n            this.uciCmd('ucinewgame')\n            this.uciCmd('isready')\n            resolve()\n        })\n    }\n\n    workerListener(event) {\n        if(this.props.debug) {\n            if(event.type === \"message\") {\n                console.log(\"  msg\", event.data)\n            } else {\n                console.log(event)\n            }\n        }\n        const line = event.data\n        if (line === 'uciok') {\n            this.engineState = ENGINE_STATE.LOADED\n        } else if (line === 'readyok') {\n            this.engineState = ENGINE_STATE.READY\n        } else {\n            let match = line.match(/^info .*\\bscore (\\w+) (-?\\d+)/)\n            if (match) {\n                const score = parseInt(match[2], 10)\n                let tmpScore\n                if (match[1] === 'cp') {\n                    tmpScore = (score / 100.0).toFixed(1)\n                } else if (match[1] === 'mate') {\n                    tmpScore = '#' + Math.abs(score)\n                }\n                this.score = tmpScore\n            }\n            // match = line.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbn])?/) // ponder is not always included\n            match = line.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbn])?( ponder ([a-h][1-8])?([a-h][1-8])?)?/)\n            if (match) {\n                this.engineState = ENGINE_STATE.READY\n                if (match[4] !== undefined) {\n                    this.ponder = {from: match[5], to: match[6]}\n                } else {\n                    this.ponder = undefined\n                }\n                const move = {from: match[1], to: match[2], promotion: match[3], score: this.score, ponder: this.ponder}\n                this.moveResponse(move)\n            } else {\n                match = line.match(/^info .*\\bdepth (\\d+) .*\\bnps (\\d+)/)\n                if (match) {\n                    this.engineState = ENGINE_STATE.THINKING\n                    this.search = 'Depth: ' + match[1] + ' Nps: ' + match[2]\n                }\n            }\n        }\n    }\n\n    calculateMove(fen, props = { level: 4 }) {\n        this.engineState = ENGINE_STATE.THINKING\n        const timeoutPromise = new Promise((resolve) => {\n            setTimeout(async () => {\n                resolve()\n            }, this.props.responseDelay)\n        })\n        const calculationPromise = new Promise ((resolve) => {\n            setTimeout(() => {\n                this.uciCmd('setoption name Skill Level value ' + (LEVELS[props.level][1]))\n                this.uciCmd('position fen ' + fen)\n                this.uciCmd('go depth ' + (LEVELS[props.level][0]))\n                this.moveResponse = (move) => {\n                    resolve(move)\n                }\n            }, this.props.responseDelay)\n        })\n        return new Promise((resolve) => {\n            Promise.all([this.initialisation, timeoutPromise, calculationPromise]).then((values) => {\n                this.engineState = ENGINE_STATE.READY\n                resolve(values[2])\n            })\n        })\n    }\n\n    uciCmd(cmd) {\n        if(this.props.debug) {\n            console.log(\"  uci ->\", cmd)\n        }\n        this.engineWorker.postMessage(cmd)\n    }\n\n}\n"],
  "mappings": "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",
  "names": []
}
