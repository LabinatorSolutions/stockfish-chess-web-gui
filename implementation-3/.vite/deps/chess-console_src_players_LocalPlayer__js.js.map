{
  "version": 3,
  "sources": ["../../node_modules/chess-console/src/players/LocalPlayer.js"],
  "sourcesContent": ["/**\n * Author and copyright: Stefan Haack (https://shaack.com)\n * Repository: https://github.com/shaack/chess-console\n * License: MIT, see file 'LICENSE'\n */\nimport {COLOR, INPUT_EVENT_TYPE} from \"cm-chessboard/src/Chessboard.js\"\nimport {Chess} from \"chess.mjs/src/Chess.js\"\nimport {ChessConsolePlayer} from \"../ChessConsolePlayer.js\"\nimport {CONSOLE_MESSAGE_TOPICS} from \"../ChessConsole.js\"\n\nexport class LocalPlayer extends ChessConsolePlayer {\n\n    constructor(chessConsole, name, props) {\n        super(chessConsole, name)\n        this.props = {\n            allowPremoves: false\n        }\n        Object.assign(this.props, props)\n        this.premoves = []\n    }\n\n    /**\n     * The return value returns, if valid or if is promotion.\n     * The callback returns the move.\n     */\n    validateMoveAndPromote(fen, squareFrom, squareTo, callback) {\n        const tmpChess = new Chess(fen)\n        let move = {from: squareFrom, to: squareTo}\n        const moveResult = tmpChess.move(move)\n        if (moveResult) {\n            callback(moveResult)\n            return true\n        } else { // is a promotion?\n            if (tmpChess.get(squareFrom) && tmpChess.get(squareFrom).type === \"p\") {\n                const possibleMoves = tmpChess.moves({square: squareFrom, verbose: true})\n                for (let possibleMove of possibleMoves) {\n                    if (possibleMove.to === squareTo && possibleMove.promotion) {\n                        const chessboard = this.chessConsole.components.board.chessboard\n                        chessboard.showPromotionDialog(squareTo, tmpChess.turn(), (event) => {\n                            console.log(event)\n                            if (event.piece) {\n                                move.promotion = event.piece.charAt(1)\n                                console.log(move)\n                                callback(tmpChess.move(move))\n                            } else {\n                                callback(null)\n                            }\n                        })\n                        return true\n                    }\n                }\n            }\n        }\n        callback(null)\n        return false\n    }\n\n    /**\n     * Handles the events from cm-chessboard\n     *\n     * INPUT_EVENT_TYPE.moveDone\n     * - validates Move, returns false, if not valid\n     * - does promotion\n     * - calls moveResponse()\n     *\n     * INPUT_EVENT_TYPE.moveStart\n     * - allowed only the right color to move\n     */\n    chessboardMoveInputCallback(event, moveResponse) {\n        // if player can make move, make, if not store as premove\n        // const boardFen = this.chessConsole.components.board.chessboard.getPosition()\n        const gameFen = this.chessConsole.state.chess.fen()\n        if (this.chessConsole.playerToMove() === this) {\n            console.log(\"chessboardMoveInputCallback\",event)\n            if (event.type === INPUT_EVENT_TYPE.validateMoveInput) {\n                return this.validateMoveAndPromote(gameFen, event.squareFrom, event.squareTo, (moveResult) => {\n                    let result\n                    if (moveResult) { // valid\n                        result = moveResponse(moveResult)\n                    } else { // not valid\n                        result = moveResponse({from: event.squareFrom, to: event.squareTo})\n                        this.premoves = []\n                        this.updatePremoveMarkers()\n                    }\n                    if (result) {\n                        if(!this.props.allowPremoves) {\n                            this.chessConsole.components.board.chessboard.disableMoveInput()\n                        }\n                    }\n                })\n            } else if (event.type === INPUT_EVENT_TYPE.moveInputStarted) {\n                if (this.chessConsole.state.plyViewed !== this.chessConsole.state.chess.plyCount()) {\n                    this.chessConsole.state.plyViewed = this.chessConsole.state.chess.plyCount()\n                    return false\n                } else {\n                    const possibleMoves = this.chessConsole.state.chess.moves({square: event.square})\n                    if(possibleMoves.length > 0) {\n                        return true\n                    } else {\n                        this.chessConsole.components.board.chessConsole.messageBroker.publish(CONSOLE_MESSAGE_TOPICS.illegalMove, {\n                            move: {\n                                from: event.squareFrom\n                            }\n                        })\n                        return false\n                    }\n                }\n            }\n        } else {\n            // premoves\n            if (event.type === INPUT_EVENT_TYPE.validateMoveInput) {\n                this.premoves.push(event)\n                this.updatePremoveMarkers()\n            }\n            return true\n        }\n    }\n\n    moveRequest(fen, moveResponse) {\n        if(!this.contextMenuEvent) {\n            this.chessConsole.components.board.chessboard.context.addEventListener(\"contextmenu\", (event) => {\n                event.preventDefault()\n                if(this.premoves.length > 0) {\n                    this.resetBoardPosition()\n                    this.premoves = []\n                    this.updatePremoveMarkers()\n                }\n            })\n            this.contextMenuEvent = true\n        }\n        const color = this.chessConsole.state.chess.turn() === 'w' ? COLOR.white : COLOR.black\n        if (!this.chessConsole.state.chess.gameOver()) {\n            if (this.premoves.length > 0) {\n                // premove\n                const eventFromPremovesQueue = this.premoves.shift()\n                this.updatePremoveMarkers()\n                setTimeout(() => {\n                    this.chessboardMoveInputCallback(eventFromPremovesQueue, moveResponse)\n                }, 20)\n                return true\n            }\n            // normal move\n            if(!this.chessConsole.components.board.chessboard.isMoveInputEnabled()) {\n                this.chessConsole.components.board.chessboard.enableMoveInput(\n                    (event) => {\n                        return this.chessboardMoveInputCallback(event, moveResponse)\n                    }, color\n                )\n            }\n        }\n    }\n\n    updatePremoveMarkers() {\n        this.chessConsole.components.board.chessboard.removeMarkers(this.chessConsole.components.board.props.markers.premove)\n        for (const premove of this.premoves) {\n            this.chessConsole.components.board.chessboard.addMarker(this.chessConsole.components.board.props.markers.premove, premove.squareTo)\n        }\n    }\n\n    resetBoardPosition() {\n        this.chessConsole.components.board.chessboard.setPosition(this.chessConsole.state.chess.fen(), true)\n    }\n\n}\n"],
  "mappings": "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",
  "names": []
}
